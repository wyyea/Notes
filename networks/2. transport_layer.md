# 传输层

## 多路复用和多路分解

+ 将多个套接字发送的内容通过主机的网络层发送称为多路复用
+ 将从主机的网络层收到的数据分解给每个套接字称为多路分解
+ UDP使用目的IP地址和端口号标识套接字
+ TCP使用源+目的IP地址和端口号表示套接字
---
## UDP
### 特点

+ 约等于IP+多路复用/分解
### 优势

+ 收到数据后能立即发送，发送速率较高，不需考虑拥塞控制
+ 无需建立连接，减少时延，且无需维护连接所用的缓存和变量，服务器能够支持更多客户
+ 分组首部较小
### 报文格式
![[udp_format.png]]
+ 检验和为所有16比特字的和（溢出需要回卷）的反码，检测时将所有16比特字相加再加上检验和应为全1
### 其他

+ DNS，以及一些实时应用使用UDP
+ 可在UDP上实现可靠通信机制，可以摆脱TCP强加的拥塞控制
---
## 可靠数据传输
### rdt1.0

+ 信道完全可靠
+ ![[rdt1.0.png]]
### rdt2.0

+ 信道可能出现比特差错，但不会丢包
+ 停等协议，在一个分组收到ACK时才进行下一个分组的发送
+ 接收方使用ACK和NAK来标识分组是否出现差错
+ ![[rdt2.0.jpg]]
+ 忽略了NAK和ACK受损的可能性
### rdt2.1

+ 在NAK或ACK受损时，发送方直接重传
+ 使用0和1标识第一次传输和重传的分组，接收方能够区分是否为冗余分组
+ ![[rdt2.1.jpg]]
### rdt2.2

+ 在ACK中添加确认分组的序号0和1，不使用NAK
+ ACK表示：分组（可能是第一次，也可能是重传）确认，或接受到的分组损坏
+ ![[rdt2.2.jpg]]
### rdt3.0（比特交替协议）

+ 信道既可能发生比特差错，也可能丢包
+ 在发送方中添加计时器，在时延超过计时器后，重传分组（可能是发送的包出错或丢包，也可能是ACK出错或丢包，还有可能是计时太短）
+ ![[rdt3.0.jpg]]
### 流水线协议

+ 停等协议的缺点：信道的利用率太低，1个RTT中只传输一个分组
+ 流水线协议：发送方可以发送多个协议，无须等待确认
+ 回退N步（Go Back N, GBN）
	+ 使用滑动窗口，维护一个允许发送的分组序号的窗口
	+ 接收方只能按顺序接收分组
	+ 采用累积确认，确认的分组序号之前的序号一定被确认
	+ 超时后发送所有未确认分组，并重启计时器
	+ 缓存简单，无须维护失序分组，但需要更多的重传
	+ ![[GBN_1.png]]
	+ ![[GBN_2.png]]
	
+ 选择重传（Selective Repeat，SR）
	+ 接收方能够确认失序分组\[rev_base, rev_base+N-1\]，向上层交付若干个连续的分组
	+ 发送方为每个已发送的分组都维护一个计时器
	+ 接受到ACK时，将窗口base移至最小未确认分组处
	+ \[rev_base-N, rev_base-1\]是已确认分组，但接收方需要发送ACK
	+ 接收方需要维护缓存，以保存失序分组
	+ ![[SR_1.png]]
	+ 在窗口过大时，有可能无法区分未确认分组和冗余分组（ACK损坏或丢失导致），因此窗口长度不能超过序号空间的一半
	+ ![[SR_2.png]]

---
## 拥塞控制

### 危害 

+ 在分组发送速率接近链路容量时，分组的排队时延急剧增加
+ 发送方需重传以补偿因缓存丢失而导致的丢包
+ 发送方需重传一些时延过大的分组（非必要重传）
+ 对于多跳路径，由于拥塞而丢弃的分组，上游路由器转发该分组所用的传输容量被浪费
### 方法

+ 端到端拥塞控制：只观察分组丢失或时延来判断网络拥塞情况，不使用网络层的显式提示
+ 网络辅助的拥塞控制：路由器向发送方提供显示反馈，如直接发送**拥塞分组**（指示出现拥塞），或在数据分组中修改某个字段来指示出现拥塞（须经历一个完整RTT）

---	
## TCP
### 报文段

+ 最大报文段长度MSS，MSS要保证TCP报文段加上TCP/IP报文段首部长度不超过单个链路层桢的最大长度，通常为1500 - 20 - 20 = 1460，文件将被划分为若干个长度为MSS的块（最后一块除外）
 ![[tcp_format.png]]
 + 序号和确认号字段用于可靠数据传输
 + 接收窗口字段用于流量控制
 + 首部长度字段为20+选项字段长度
 
### 可靠数据传输

+ 序号不是报文段的序号，是报文段首字节的字节流编号，确认号为期望收到下一字节的序号
+ 将确认装载到一个含有数据的报文段中，被称为被捎带（piggyback）
+ 使用累积确认，只确认第一个丢失字节
+ 一般会缓存失序字节，等待缺少的字节以填补间隔
+ 定时器超时置换重传最小序号未被确认的报文段
+ TCP可被认为是GBN和SR的混合体
+ ![[tcp_rdt.png]]
+ 特殊机制：
	+ 超时间隔加倍(提供了有限程度的拥塞控制)：重传时设置超时间隔为之前的两倍，直到收到上层数据或收到ACK后重新使用EstimatedRTT和DevRTT计算新的TimeoutInterval
	+ 快速重传：３个冗余ACK即进行重传
	+ 时间间隔计算：使用指数移动加权平均，$\alpha, \beta$典型值为0.125，0.25
		$EstimatedRTT = (1-\alpha) * EstimatedRTT + \alpha * sampleRTT$
		$DevRTT = (1-\beta) * DevRTT + \beta * |SampleRTT - EstimatedRTT|$
		$TimeoutInterval = EstimatedRTT + 4 * DevRTT$
		$TimeoutInterval$　初始值推荐为１秒
### 流量控制

+ 接收方向发送方提供接收窗口，用于指示接收方剩余的缓存空间大小
	 对接收方：$rwnd = RevBuffer - [\ LastByteRcvd - LastByteRead\ ]$
	 对发送方：$LastByteSent - LastByteAcked \leq rwnd$
+ 当rwnd=0时，发送方持续发送只有一个字节数据的报文段，用于获取缓存清空后的rwnd值，否则接收方永远不会主动告知清空后的rwnd值
+ UDP不提供流量控制，在缓存溢出时，会导致报文段丢失
### 连接管理

+ 三次握手：
	+ 客户端发送SYN报文，SYN置一，无数据，会随机选择一个client_isn
	+ 服务器收到SYN报文后，分配TCP缓存和变量，并发送SYNACK报文段，SYN置一，ACK为client_isn+1，序号为server_isn
	+ 客户收到SYNACK报文后，分配TCP缓存和变量，发送含数据的报文段，SYN置零，ACK为server_isn，序号为client_isn+1
+ 四次挥手：
	+ 客户向服务器发送FIN被置为１的终止报文段
	+ 服务器收到后，回送一个ACK报文段
	+ 服务器在发送完数据后，向客户端发送终止报文段
	+ 客户对服务器的终止报文段进行确认，并在等待2个RTT后关闭连接（若该确认丢失，服务器会重传FIN报文段；或者服务器的最后一个数据在FIN之后到达）
	+ ![[handshake_client.png|300]]![[handshake_server.png|300]]
	+ 两次握手的困境：
	![[Pasted image 20240514120946.png|300]]![[Pasted image 20240514121027.png|300]]
	
+ SYN洪泛攻击，向服务器发送大量SYN报文段，而不进行第三次握手，导致服务器产生大量半开连接（已创建缓存和变量）。通常服务器会使用源＋目的IP+port计算出server_isn，直到收到第三次握手时得到的ACK为server_isn+1，才创建连接并分配缓存和变量
+ 不接受连接的端口会在收到SYN报文段后发送RST报文
### 拥塞控制

+ 使用拥塞窗口，丢包时减小窗口，收到确认时增大窗口，探测/适应最大的链路容量
+ ![[congestion_control.png]]
	
+ 慢启动：一个确认就将窗口增加一个报文段，从而指数增长
+ 拥塞避免：传递完一个窗口才增加一个报文段，即一个确认窗口增加 MSS/cwnd
+ 快速恢复：每收到一个冗余ACK（接收方多收了一个失序分组），窗口增加一个报文段，在收到真正ACK进入拥塞避免，并重置冗余ACK数为０
+ 主要转换：
	+ 达到慢启动阈值时转移到拥塞避免
	+ 超时和３个冗余ACK都将阈值设为cwnd/2
	+ ３个冗余ACK时转移到快速恢复，cwnd = ssthrsh + 3 * MSS（代表接收方多收了３个失序分组）
	+ 超时会重回慢启动，将cwnd设为１
+ Tahoe版TCP，３个冗余ACK也将cwnd设为１，Reno版TCP使用快速恢复
+ 使用加性增，乘性减（AIMD, Additive-Increase, Multiplicative-Decrease），有较好的性能
	+ 也具有较好的公平性，两个连接趋向于平等带宽共享
	![[AIMD.png|400]]
+ 一般在拥塞避免和快速恢复之间来回，平均吞吐量为$\frac{0.75\times W}{RTT}$, W为丢包时窗口大小
+ TCP CUBIC:
	+ 认为拥塞避免时加性增过于谨慎，应尽快逼近链路最大容量
	+ 令$W_{max}$为丢包时拥塞窗口大小，令Ｋ为下次到达$W_{max}$的时间，使用t与Ｋ距离的立方为函数增加拥塞窗口，从而在离Ｋ远时快速增加，离Ｋ近时谨慎增加，在ｔ超过Ｋ时得到快速增加（链路拥塞程度显著减少，快速探测新的最大容量）
	![[tcp_cubic.png]]
 


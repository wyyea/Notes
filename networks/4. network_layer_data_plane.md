# 网络层：数据平面
## 网络服务模型
### 提供服务 

+ 确保交付
+ 具有时延上界的确保交付
+ 有序分组交付
+ 确保最小带宽
+ 安全性
+ 网络层不能提供上述任何一种保证，只做**尽力而为服务（best-effort service）**
---
## 路由器工作原理
### 转发

+ 根据目的IP地址，在转发表中使用最长前缀匹配进行匹配，寻找转发端口
### 交换

+ ![[network_switch.png]]
+ 经内存交换：若内存读写速率为B，则总转发吞吐量不超过B/2，且不能同时转发两个分组（即使有不同的输出端口），因为共享系统总线一次只能执行一个内存读/写
+ 经总线交换：分组能被每个输出端口收到，只有匹配的端口才保留分组，每次只能有一个分组跨越总线，带宽受总线速率限制
+ 经互联网络交换：交换机是非阻塞的，只要没有其他分组转发到该端口，转发到该端口的分组就不会被阻塞，否则会被阻塞
### 排队

+ 设输入和输出线路速率均为$R_{line}$，交换速率为$R_{switch}$，有N个输入和输出端口
+ 在$R_{switch}= N * R_{line}$时，输入不会排队，但输出仍会排队（如所有分组的输出端口相同）
+ 队列首部阻塞（HOL），由于输出端口竞争B被阻塞，与B同一队列但在B后的C也被阻塞
+ ![[network_hol.png|300]]
+ 缓存：更大的缓存可以减少丢包，但也意味着潜在的更长的排队时延（**缓存膨胀**，bufferbloat），同时增加的RTT还会导致TCP发送方对拥塞或丢包的响应速度变慢
### 队列调度

+ 先进先出，先来先服务(FIFO, FCFS)
+ 优先权排队：每次都选择最高优先级队列中的任务进行传输，同一优先级队列中FCFS，若为非抢占式，则传输一旦开始，则不能打断
+ 循环加加权公平排队：循环调度器在不同优先级队列中进行循环，确保类 i 接收到的服务部分为$w_i / (\Sigma w_j)$，但若为非抢占式，则无法理想地保证这一事实
---
## IPv4
### 数据报格式
![[ipv4_format.png]]
+ 首部长度一般为20字节
+ 服务类型(TOS)，用以区分不同类型的IP数据报，如实时和非实时
+ 数据报长度，IP数据报的总长度，首部加上数据，字节为单位
+ 标识，标志，片偏移：与IP分片有关
+ 寿命（TTL）：确保数据报不会在网络中循环
+ 协议：在目的地时确定将数据交给哪个上层协议，如TCP,UDP,ICMP
+ 首部检验和：每台路由器必须重新计算TTL，首部检验和
### 编址

+ IP地址长度为32，表示为a.b.c.d，255.255.255.255表示广播地址
+ 以路由器为边界的网络为子网，子网一般有共同的前缀，使用子网掩码标识，如a.b.c.d/x
+ DHCP(动态主机配置协议) ，是一个即插即用协议
	+ 动态分配IP地址
	+ 主机能通过DHCP获得IP地址，子网掩码，第一条路由器地址（默认网关），本地DNS服务器
	+ 过程有4个步骤，DHCP发现，DHCP提供，DHCP请求，DHCP ACK，主机可从多个DHCP提供中选择一个进行请求
	![[dhcp.png|400]]
+ 网络地址转换（NAT）：
	+ 通过NAT转换表完成
	+ 内部主机向外发送IP数据报时，NAT路由器申请一个新的端口，将源IP/port转换为路由器的IP/port，并将映射添加到NAT转换表
	+ NAT路由器收到外部IP数据报时，根据NAT转换表将目的IP/port进行转换
	+ 隐藏了内部网络的细节，易于内部编址，但外部难以直接访问内部
---
## IPv6
### 数据报格式
![[ipv6_format.png]]
+ 地址长度为128位，还添加了任播地址（交付到一组主机中的任意一个） 
+ 舍弃了选项，首部长度固定为40字节
+ 流标签，不同流可进行特殊处理，或获得不同优先级
+ 流量类型，与IPv4中TOS相似
+ 有效载荷长度，在40字节首部后的字节数量
+ 跳限制，类似TTL
## 与IPv4不同

+ 不允许分片，分片/重新组装是耗时操作，IPv6通过ICMP报文要求发送方重发一个较小的报文
+ 不添加首部检验和，认为每次对检验和进行计算是耗时操作
+ 删除选项，选项出现在**下一个首部**的位置
### 从IPv4到IPv6的迁移（隧道）

+ 将IPv6数据报放在IPv4的载荷中，将目的地址设为下一个IPv6的路由器，能够穿过中间的IPv4路由器，在目的路由器被提取出来继续转发
![[ipv6_tunnel.png|400]]

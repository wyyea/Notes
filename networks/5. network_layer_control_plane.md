# 网络层：控制平面

## 路由选择算法
### 链路状态路由选择算法(Link State, LS)

+ 本质为Dijkstra，为集中式算法，每台路由器都需知道全局信息，也定时广播自身状态
![[Pasted image 20240514224135.png|300]]![[Pasted image 20240514224151.png|300]]
+ 会发生路由选择的震荡，可通过随机化各路由器执行LS算法的时间（这样还是会自发趋向同步，改为通过随机化广播链路状态的时间）来防止震荡
![[ls_oscillate.png]]
### 距离向量路由算法（Distance-Vector, DV）

+ 本质为Bellman-ford
+ 每个节点维护到相邻邻居的开销，自身的距离向量（到每个路由器的距离），所有邻居的距离向量
+ 当该节点的距离向量发生变化时，向所有邻居发送新的距离向量；收到新的距离向量时，重新计算自身距离向量
![[dv.png|400]]
+ 链路开销改变时，会发生路由选择环路（无穷计数），链路开销增加的消息传播速度太慢
	+ 增加毒性逆转，若x通过y到z，则x不向y通报其通向z的路径（将其长度设为$\infty$）
	+ 毒性逆转只能解决2个相邻节点的无穷计数，3个或更多节点的环路无法解决
	![[dv_routing_loop.png|400]]
### 两个算法比较

+ LS算法需要发送O(NE)个报文，且一条链路开销改变时，需向所有节点发送新的开销
+ 收敛速度：LS可在O($N^{2}$) 收敛，而DV收敛较慢，会遇到无穷计数
+ 健壮性：
	+ LS只计算自己的转发表，路由计算某种程度时分离的，具有一定健壮性
	+ DV：错误的链路开销会逐渐扩散到整个网络，如导致某一低开销的路由器有大量流量流入
---
## 自治系统内部路由算法
### 自治系统

+ 自治系统（Autonomous System, AS）由多个路由器构成
+ 一个ISP可有一个或多个AS
+ AS内部执行内部路由选择协议进行路由
+ AS内部包含主干区域，主干区域包含所有区域边界路由器(和一些其他路由器)，区域间路由会先路由到边界路由器，在路由到区域外路由器
### 开放最短路优先（OSPF）
+ 内部使用Dijkstra算法，链路开销可能全设为１（最少跳路由选择），或设为与链路容量成反比，从而不鼓励流量使用低带宽链路
+ 即使链路状态未改变，也会周期性广播链路状态
+ OSPF通告直接有IP承载，上层协议值为89
+ OSPF可使用多条相同开销的路径，即无需使用单条路径承担所有流量
---
## ISP之间路由选择（BGP）
### 原理

+ BGP允许AS向其他AS通告某个子网的存在
+ 该通告为一个路径，如AS2 AS3 x, 指示从AS1->AS2->AS3，子网ｘ在AS3内部
### 路由选择

+ 热土豆法：
	+ 选择到达NEXT-HOP路由器最小开销的路径，
	+ 自私的算法，未考虑AS外部到目的地的余下部分的开销
+ 一种路由器选择算法，从上到下依次选择：
	+ 通过本地偏好（被只派的某种属性）选择
	+ 通过最短AS-PATH选择，AS-PATH长度以AS跳数计，不是路由器跳数
	+ 通过热土豆法选择
	+ 使用BGP标识符选择
### IP任播

+ 多个提供同一服务但在不同位置的服务器使用同一IP地址向外通告其存在
+ DNS收到后会根据BGP选择算法进行选择
+ 从而主机能够得到一个较近(较好)的服务器
+ 一个典型例子是用于指示最近的根DNS服务器
### 路由选择策略

+ 接入ISP（只作为起点和终点）向邻居通告它没有通向任何其他目的地的路径（除自身之外）
+ 多宿接入ISP：通过多个不同的提供商连接到网络的其余部分
+ 提供商网络，原则为：任何穿越某ISP主干网的流量必须是其源或目的（或两者）位于该ISP的某个客户网络中，否则这些流量会免费搭车通过该ISP的网络
 ![[bgp_policy.png]]
 上图中B不会向C通告路径WAB，因为W-A-B-C的两端都不是B的客户
 ---
## ICMP

+ ICMP在IP之上，作为IP有效载荷承载，向TCP一样
+ 用于指示网络信息，如错误等
+ ping程序就是向目的主机发送ICMP回显请求，目的主机发送回显回答
+ traceroute程序会向目的主机依次发送TTL=1,2,3...的具有不可达UDP端口的UDP报文
	+ 前n-1个路由器会丢弃数据报并发送TTL过期的ICMP报文
	+ 目的主机会发送端口不可达的ICMP报文，主机收到该报文后知道不须在发送额外的探测分组
	+ traceroute一般给每个TTL发送3个一组的分组
今天